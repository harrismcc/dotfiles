{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash

# Install homebrew if it's not already installed
if ! command -v brew &> /dev/null
then
    echo "Installing Homebrew"
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    echo "Adding homebrew to PATH"
    echo >> ~/.zprofile
    echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
    eval "$(/opt/homebrew/bin/brew shellenv)"
    export PATH="/opt/homebrew/bin:$PATH"
fi

echo "Installing Homebrew packages"
brew bundle --file=/dev/stdin <<EOF
{{ range .packages.darwin.taps -}}
tap {{ . | quote }}
{{ end -}}
{{ range .packages.darwin.brews -}}
brew {{ . | quote }}
{{ end -}}
{{ range .packages.darwin.casks -}}
cask {{ . | quote }}
{{ end -}}
mas "Wireguard", id: 1451685025

EOF

echo "Installing Mac App Store apps"
{{ range .packages.darwin.apps -}}
mas purchase {{ . | quote }}
mas install {{ . | quote }}
{{end -}}

echo "Applying Raycast Backup"
# Raycast hash: {{ include "external_datafiles/external_raycast-backup.rayconfig" | sha256sum }}

# Remove keybind for old spotlight
/usr/libexec/PlistBuddy -c "Set :AppleSymbolicHotKeys:64:enabled false" ~/Library/Preferences/com.apple.symbolichotkeys.plist
/usr/libexec/PlistBuddy -c "Set :AppleSymbolicHotKeys:65:enabled false" ~/Library/Preferences/com.apple.symbolichotkeys.plist

echo "Path: {{ .chezmoi.sourceDir }}"
open {{ .chezmoi.sourceDir }}/external_datafiles/external_raycast-backup.rayconfig

{{ end -}}
